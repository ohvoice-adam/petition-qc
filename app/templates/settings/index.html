{% extends "base.html" %}

{% block title %}Settings - Petition QC{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto space-y-8">
    <h1 class="text-2xl font-bold">Settings</h1>

    <!-- ── Application Settings ── -->
    <form method="POST" class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm space-y-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Application Settings</h2>

        <div>
            <label for="target_city" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Target City for Signature Verification
            </label>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">
                Signatures from residents of this city will be counted as "verified". Statistics will show the percentage of signatures from this city.
            </p>
            <select name="target_city" id="target_city"
                    class="block w-full rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white px-3 py-2 focus:border-navy-500 focus:ring-navy-500">
                {% for city in cities %}
                <option value="{{ city.value }}" {% if city.value == current_city %}selected{% endif %}>
                    {{ city.label }} ({{ "{:,}".format(city.count) }} voters)
                </option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="signature_goal" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Signature Goal
            </label>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">
                Set a target number of verified signatures to track progress on the stats page.
            </p>
            <input type="number" name="signature_goal" id="signature_goal"
                   value="{{ signature_goal or '' }}"
                   min="0" step="1"
                   placeholder="e.g., 5000"
                   class="block w-full rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white px-3 py-2 focus:border-navy-500 focus:ring-navy-500">
        </div>

        <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
            <div class="text-sm text-gray-500 dark:text-gray-400">
                Currently set to: <span class="font-medium text-gray-900 dark:text-white">{{ current_city.title() if current_city else 'Not set' }}</span>
            </div>
            <button type="submit"
                    class="bg-accent-500 hover:bg-accent-600 text-white font-medium py-2 px-4 rounded-md">
                Save Settings
            </button>
        </div>
    </form>

    <!-- ── Backup Configuration ── -->
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm space-y-6">
        <div>
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Database Backup</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Backs up all tables except the voter file via SCP/SFTP to a remote server.
                The backup is in PostgreSQL custom format and can be restored with
                <code class="font-mono bg-gray-100 dark:bg-gray-700 px-1 rounded">pg_restore</code>.
            </p>
        </div>

        <!-- Backup status -->
        <div class="rounded-md px-4 py-3 text-sm
            {% if backup_config.last_status == 'running' %}
                bg-blue-50 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 border border-blue-200 dark:border-blue-700
            {% elif backup_config.last_status == 'success' %}
                bg-green-50 dark:bg-green-900/30 text-green-800 dark:text-green-200 border border-green-200 dark:border-green-700
            {% elif backup_config.last_status.startswith('error:') %}
                bg-red-50 dark:bg-red-900/30 text-red-800 dark:text-red-200 border border-red-200 dark:border-red-700
            {% else %}
                bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-400 border border-gray-200 dark:border-gray-600
            {% endif %}">
            {% if backup_config.last_status == 'running' %}
                <span class="font-medium">Backup in progress&hellip;</span>
                Reload the page to check the result.
            {% elif backup_config.last_status == 'success' %}
                <span class="font-medium">Last backup succeeded.</span>
                {% if backup_config.last_run %}
                    Started {{ backup_config.last_run[:19].replace('T', ' ') }}.
                {% endif %}
            {% elif backup_config.last_status.startswith('error:') %}
                <span class="font-medium">Last backup failed:</span>
                {{ backup_config.last_status[6:] }}
            {% else %}
                No backups have been run yet.
            {% endif %}
        </div>

        <!-- Run backup + test connection buttons -->
        {% if backup_configured %}
        <div class="flex items-center gap-3 flex-wrap">
            <form method="POST" action="{{ url_for('settings.run_backup') }}">
                <button type="submit"
                        {% if backup_config.last_status == 'running' %}disabled{% endif %}
                        class="bg-navy-600 hover:bg-navy-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-medium py-2 px-4 rounded-md text-sm">
                    {% if backup_config.last_status == 'running' %}
                        Backup Running&hellip;
                    {% else %}
                        Run Backup Now
                    {% endif %}
                </button>
            </form>

            <button id="test-conn-btn" type="button"
                    onclick="testBackupConnection()"
                    class="bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium py-2 px-4 rounded-md text-sm">
                Test Connection
            </button>
            <input type="password" id="test-password"
                   placeholder="Password (optional, not saved)"
                   class="rounded-md bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white px-3 py-2 text-sm focus:border-navy-500 focus:ring-navy-500 w-56">
            <span id="test-conn-result" class="text-sm hidden whitespace-pre-wrap break-words max-w-full block mt-2"></span>
        </div>
        {% endif %}

        <!-- SCP configuration form -->
        <form method="POST" action="{{ url_for('settings.save_backup_config') }}"
              enctype="multipart/form-data"
              class="space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700">
            <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300">SCP / SFTP Configuration</h3>

            <div class="grid grid-cols-3 gap-4">
                <div class="col-span-2">
                    <label for="scp_host" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Host
                    </label>
                    <input type="text" name="scp_host" id="scp_host"
                           value="{{ backup_config.scp_host }}"
                           placeholder="backup.example.com"
                           class="block w-full rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white px-3 py-2 text-sm focus:border-navy-500 focus:ring-navy-500">
                </div>
                <div>
                    <label for="scp_port" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Port
                    </label>
                    <input type="number" name="scp_port" id="scp_port"
                           value="{{ backup_config.scp_port or '22' }}"
                           min="1" max="65535"
                           class="block w-full rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white px-3 py-2 text-sm focus:border-navy-500 focus:ring-navy-500">
                </div>
            </div>

            <div>
                <label for="scp_user" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Username
                </label>
                <input type="text" name="scp_user" id="scp_user"
                       value="{{ backup_config.scp_user }}"
                       placeholder="backupuser"
                       class="block w-full rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white px-3 py-2 text-sm focus:border-navy-500 focus:ring-navy-500">
            </div>

            <div>
                <label for="scp_key_file" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    SSH Private Key
                </label>
                {% if backup_config.has_key %}
                <p class="flex items-center gap-1.5 text-xs text-green-700 dark:text-green-400 mb-1">
                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414L8.414 15l-4.121-4.121a1 1 0 011.414-1.414L8.414 12.172l7.879-7.879a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                    Key configured. Upload a new file to replace it.
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-400 font-mono mb-2">
                    Fingerprint: {{ backup_config.key_fingerprint }}
                    &mdash; compare with <code class="bg-gray-100 dark:bg-gray-700 px-1 rounded">ssh-keygen -l -f ~/.ssh/id_rsa</code>
                </p>
                {% else %}
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">
                    Upload a PEM-format private key file (e.g. <code class="font-mono bg-gray-100 dark:bg-gray-700 px-1 rounded">id_ed25519</code> or <code class="font-mono bg-gray-100 dark:bg-gray-700 px-1 rounded">id_rsa</code>).
                    The key is stored securely in the database.
                </p>
                {% endif %}
                <input type="file" name="scp_key_file" id="scp_key_file"
                       accept=".pem,.key,text/plain"
                       class="block w-full text-sm text-gray-700 dark:text-gray-300
                              file:mr-3 file:py-1.5 file:px-3 file:rounded file:border-0
                              file:text-sm file:font-medium
                              file:bg-gray-100 dark:file:bg-gray-700
                              file:text-gray-700 dark:file:text-gray-200
                              hover:file:bg-gray-200 dark:hover:file:bg-gray-600">
            </div>

            <div>
                <label for="scp_remote_path" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Remote Directory
                </label>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">
                    Directory on the remote server where backups will be stored. Must already exist and be writable.
                </p>
                <input type="text" name="scp_remote_path" id="scp_remote_path"
                       value="{{ backup_config.scp_remote_path }}"
                       placeholder="/backups/petition-qc"
                       class="block w-full rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white px-3 py-2 text-sm font-mono focus:border-navy-500 focus:ring-navy-500">
            </div>

            <div>
                <label for="backup_schedule" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Automatic Schedule
                </label>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">
                    Scheduled backups run at midnight UTC (daily/weekly) or on the hour (hourly).
                </p>
                <select name="backup_schedule" id="backup_schedule"
                        class="block w-full rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white px-3 py-2 text-sm focus:border-navy-500 focus:ring-navy-500">
                    <option value=""      {% if not backup_config.schedule %}selected{% endif %}>Disabled</option>
                    <option value="hourly" {% if backup_config.schedule == 'hourly' %}selected{% endif %}>Hourly (at :00)</option>
                    <option value="daily"  {% if backup_config.schedule == 'daily'  %}selected{% endif %}>Daily (02:00 UTC)</option>
                    <option value="weekly" {% if backup_config.schedule == 'weekly' %}selected{% endif %}>Weekly (Sunday 02:00 UTC)</option>
                </select>
            </div>

            <div class="flex justify-end pt-2">
                <button type="submit"
                        class="bg-accent-500 hover:bg-accent-600 text-white font-medium py-2 px-4 rounded-md text-sm">
                    Save Backup Config
                </button>
            </div>
        </form>
    </div>

    <!-- ── Email / SMTP Configuration ── -->
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm space-y-6">
        <div>
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Email (SMTP)</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Required for password reset emails. Configure your outgoing mail server below.
            </p>
        </div>

        <!-- SMTP status banner -->
        <div class="rounded-md px-4 py-3 text-sm
            {% if smtp_configured %}
                bg-green-50 dark:bg-green-900/30 text-green-800 dark:text-green-200 border border-green-200 dark:border-green-700
            {% else %}
                bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-400 border border-gray-200 dark:border-gray-600
            {% endif %}">
            {% if smtp_configured %}
                <span class="font-medium">Email is configured.</span>
                Password reset emails will be sent via {{ smtp_config.host }}.
            {% else %}
                Email is not configured. Password reset will not be available until you fill in the settings below.
            {% endif %}
        </div>

        <!-- Send test email button -->
        {% if smtp_configured %}
        <div class="flex items-center gap-3 flex-wrap">
            <button id="test-smtp-btn" type="button"
                    onclick="testSmtp()"
                    class="bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium py-2 px-4 rounded-md text-sm">
                Send Test Email
            </button>
            <span id="test-smtp-result" class="text-sm hidden"></span>
        </div>
        {% endif %}

        <!-- SMTP configuration form -->
        <form method="POST" action="{{ url_for('settings.save_smtp_config') }}"
              class="space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700">
            <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300">SMTP Configuration</h3>

            <div class="grid grid-cols-3 gap-4">
                <div class="col-span-2">
                    <label for="smtp_host" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Host
                    </label>
                    <input type="text" name="smtp_host" id="smtp_host"
                           value="{{ smtp_config.host }}"
                           placeholder="smtp.example.com"
                           class="block w-full rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white px-3 py-2 text-sm focus:border-navy-500 focus:ring-navy-500">
                </div>
                <div>
                    <label for="smtp_port" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Port
                    </label>
                    <input type="number" name="smtp_port" id="smtp_port"
                           value="{{ smtp_config.port or '587' }}"
                           min="1" max="65535"
                           class="block w-full rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white px-3 py-2 text-sm focus:border-navy-500 focus:ring-navy-500">
                </div>
            </div>

            <div>
                <label for="smtp_user" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Username
                </label>
                <input type="text" name="smtp_user" id="smtp_user"
                       value="{{ smtp_config.user }}"
                       placeholder="user@example.com"
                       class="block w-full rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white px-3 py-2 text-sm focus:border-navy-500 focus:ring-navy-500">
            </div>

            <div>
                <label for="smtp_password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Password
                </label>
                {% if smtp_config.has_password %}
                <p class="text-xs text-green-700 dark:text-green-400 mb-1">
                    Password configured. Leave blank to keep the existing password.
                </p>
                {% endif %}
                <input type="password" name="smtp_password" id="smtp_password"
                       placeholder="{% if smtp_config.has_password %}(unchanged){% else %}SMTP password{% endif %}"
                       autocomplete="new-password"
                       class="block w-full rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white px-3 py-2 text-sm focus:border-navy-500 focus:ring-navy-500">
            </div>

            <div>
                <label for="smtp_from_email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    From Address
                </label>
                <input type="email" name="smtp_from_email" id="smtp_from_email"
                       value="{{ smtp_config.from_email }}"
                       placeholder="noreply@example.com"
                       class="block w-full rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white px-3 py-2 text-sm focus:border-navy-500 focus:ring-navy-500">
            </div>

            <div class="flex items-center gap-2">
                <input type="checkbox" name="smtp_use_tls" id="smtp_use_tls" value="1"
                       {% if smtp_config.use_tls != 'false' %}checked{% endif %}
                       class="rounded border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-navy-600">
                <label for="smtp_use_tls" class="text-sm font-medium text-gray-700 dark:text-gray-300">
                    Use STARTTLS (recommended)
                </label>
            </div>

            <div class="flex justify-end pt-2">
                <button type="submit"
                        class="bg-accent-500 hover:bg-accent-600 text-white font-medium py-2 px-4 rounded-md text-sm">
                    Save Email Config
                </button>
            </div>
        </form>
    </div>
</div>

<script>
async function testSmtp() {
    const btn = document.getElementById('test-smtp-btn');
    const result = document.getElementById('test-smtp-result');
    btn.disabled = true;
    btn.textContent = 'Sending\u2026';
    result.className = 'text-sm text-gray-500 dark:text-gray-400';
    result.textContent = 'Sending test email\u2026';
    result.classList.remove('hidden');

    try {
        const resp = await fetch('{{ url_for("settings.test_smtp") }}', { method: 'POST' });
        let data;
        try {
            data = await resp.json();
        } catch (_) {
            result.className = 'text-sm font-medium text-red-600 dark:text-red-400';
            result.textContent = `Server error (HTTP ${resp.status}) — check application logs.`;
            return;
        }
        result.className = data.ok
            ? 'text-sm font-medium text-green-700 dark:text-green-400'
            : 'text-sm font-medium text-red-600 dark:text-red-400';
        result.textContent = data.message;
    } catch (e) {
        result.className = 'text-sm font-medium text-red-600 dark:text-red-400';
        result.textContent = 'Connection to server lost — check that the application is running.';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Send Test Email';
    }
}

async function testBackupConnection() {
    const btn = document.getElementById('test-conn-btn');
    const result = document.getElementById('test-conn-result');
    btn.disabled = true;
    btn.textContent = 'Testing\u2026';
    result.className = 'text-sm text-gray-500 dark:text-gray-400';
    result.textContent = 'Connecting\u2026';
    result.classList.remove('hidden');

    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), 12000);

    const body = new FormData();
    const pw = document.getElementById('test-password').value;
    if (pw) body.append('test_password', pw);

    try {
        const resp = await fetch('{{ url_for("settings.test_backup_connection") }}', {
            method: 'POST',
            body: body,
            signal: controller.signal,
        });
        clearTimeout(timer);

        let data;
        try {
            data = await resp.json();
        } catch (_) {
            result.className = 'text-sm font-medium text-red-600 dark:text-red-400';
            result.textContent = `Server error (HTTP ${resp.status}) — check application logs.`;
            return;
        }

        result.className = data.ok
            ? 'text-sm font-medium text-green-700 dark:text-green-400'
            : 'text-sm font-medium text-red-600 dark:text-red-400';
        result.textContent = data.message;
    } catch (e) {
        clearTimeout(timer);
        result.className = 'text-sm font-medium text-red-600 dark:text-red-400';
        result.textContent = e.name === 'AbortError'
            ? 'Timed out — the host may be unreachable or the server is not responding.'
            : 'Connection to server lost — check that the application is running.';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Test Connection';
    }
}
</script>
{% endblock %}
